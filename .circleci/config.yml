version: 2.1

commands:
  install-awscli:
    description: Install aws cli
    steps:
      - run:
          name: Install aws cli
          command: |
            # Install AWS cli
            current_dir=$( pwd )
            cd /tmp/
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
  install-ansible:
    description: Install ansible
    steps:
      - run:
          name: Install ansible
          command: |
            sudo apt update
            sudo apt install -y python3-venv python3-pip
            python3 -m pip install --upgrade pip
            python3 -m pip install --user ansible

  install-eksctl:
    description: Install eksctl
    steps:
      - run:
          name: Install eksctl
          command: |
            sudo apt update
            curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
            sudo mv /tmp/eksctl /usr/local/bin
            eksctl version

jobs:
  test-lint-build:
    docker:
      - image: python:3.7.3-stretch
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements.txt" }}
            - v1-dependencies-
      - run:
          name: install dependencies
          command: |
            python3 -m venv venv
            . venv/bin/activate
            make install
      - run:
          name: run lint
          command: |
            . venv/bin/activate
            make lint
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}
  
  build-scan-upload-docker:
    docker:
      - image: circleci/golang:1.15

    working_directory: ~/repo

    steps:
      - checkout

      - setup_remote_docker:
          version: 19.03.13

      - run:
          name: Install docker-scan-plugin
          command: |
            mkdir -p ~/.docker/cli-plugins && \
            curl https://github.com/docker/scan-cli-plugin/releases/latest/download/docker-scan_linux_amd64 -L -s -S -o ~/.docker/cli-plugins/docker-scan &&\
            chmod +x ~/.docker/cli-plugins/docker-scan

      - run:
          name: Build docker container
          command: |
            docker build --tag=$DOCKER_NAME .
            docker image ls

      - run:
          name: Upload Docker to Dockerhub
          command: |
            echo "Docker ID and Image: $DOCKER_NAME"
              docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
            docker tag $DOCKER_NAME $DOCKER_USERNAME/$DOCKER_NAME:$CIRCLE_WORKFLOW_ID
            docker push $DOCKER_USERNAME/$DOCKER_NAME:$CIRCLE_WORKFLOW_ID
  
  deploy-infrastructure:
    docker:
      - image: cimg/aws:2023.04
    steps:
      - checkout
      - install-eksctl
      - run:
          name: "Ensure back-end infrastructure exists"
          command: |
              eksctl create cluster --name eksctl-capstone --region=us-east-1

workflows:
  default:
    jobs:
      - test-lint-build
      - build-scan-upload-docker:
          requires:
            - test-lint-build
      - deploy-infrastructure:
          requires:
                - build-scan-upload-docker